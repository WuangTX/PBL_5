{% extends 'base.html' %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css" rel="stylesheet">
<style>
    .stats-card {
        transition: transform 0.3s ease;
    }
    .stats-card:hover {
        transform: translateY(-3px);
    }
    .camera-frame {
        width: 100%;
        height: auto;
        aspect-ratio: 16/9;
        max-height: 400px; /* Giảm từ 600px xuống 400px */
        border-radius: 8px;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    .camera-frame img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 8px;
    }
    .chart-container {
        height: 300px;
        max-height: 50vh;
    }
    .camera-controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        padding: 8px;
    }
    .camera-controls .btn {
        flex: 1;
        min-width: 100px; /* Giảm từ 120px xuống 100px */
        max-width: 150px; /* Giảm từ 200px xuống 150px */
        padding: 6px; /* Giảm từ 8px xuống 6px */
        font-size: clamp(0.7rem, 1.5vw, 0.85rem); /* Giảm kích thước chữ */
        white-space: nowrap;
    }
    .camera-controls .btn i {
        margin-right: 4px;
        font-size: 0.9em;
    }

    /* Responsive breakpoints */
    @media (max-width: 1200px) {
        .camera-frame {
            max-height: 350px; /* Giảm từ 500px xuống 350px */
        }
        .chart-container {
            height: 250px;
        }
    }

    @media (max-width: 992px) {
        .camera-frame {
            max-height: 300px; /* Giảm từ 400px xuống 300px */
        }
        .chart-container {
            height: 220px;
        }
    }

    @media (max-width: 768px) {
        .camera-frame {
            max-height: 250px; /* Giảm từ 350px xuống 250px */
        }
        .chart-container {
            height: 200px;
        }
        .camera-controls .btn {
            min-width: 80px; /* Giảm từ 100px xuống 80px */
            padding: 4px; /* Giảm từ 6px xuống 4px */
        }
    }

    @media (max-width: 576px) {
        .camera-frame {
            max-height: 200px; /* Giảm từ 300px xuống 200px */
        }
        .camera-controls {
            flex-direction: row;
            flex-wrap: wrap;
        }
        .camera-controls .btn {
            flex: 1 1 40%;
            font-size: 0.75rem; /* Giảm từ 0.8rem xuống 0.75rem */
            padding: 3px; /* Thêm padding nhỏ hơn cho màn hình nhỏ */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid g-0">
    <!-- Statistics Cards Row -->
    <div class="row g-2 mb-3">
        <div class="col-6 col-md-3">
            <div class="card bg-primary text-white h-100 stats-card">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1" style="font-size: 0.8rem;">Xe đang đỗ</h6>
                            <h3 class="mb-0">{{ parked_vehicles }}</h3>
                        </div>
                        <i class="fas fa-car fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card bg-success text-white h-100 stats-card">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1" style="font-size: 0.8rem;">Chỗ trống</h6>
                            <h3 class="mb-0">{{ available_spaces }}</h3>
                        </div>
                        <i class="fas fa-parking fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card bg-info text-white h-100 stats-card">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1" style="font-size: 0.8rem;">Tỷ lệ lấp đầy</h6>
                            <h3 class="mb-0">{{ occupancy_rate|floatformat:1 }}%</h3>
                        </div>
                        <i class="fas fa-chart-pie fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card bg-warning text-white h-100 stats-card">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1" style="font-size: 0.8rem;">Cảnh báo</h6>
                            <h3 class="mb-0">{{ long_term_vehicles.count|add:unregistered_vehicles.count }}</h3>
                        </div>
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <!-- Camera Controls Section -->
        <div class="col-12 col-xl-7">
            <!-- Camera Chung -->
            <div class="card h-90">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-video me-1"></i>Camera Giám Sát</h6>
                </div>
                <div class="card-body p-2">
                    <div class="camera-frame mb-3">
                        <img id="camera-feed" src="http://127.0.0.1:5000/video_feed" alt="Camera Feed" class="img-fluid">
                    </div>
                    <div class="camera-controls">
                        <button class="btn btn-primary btn-sm" id="startCamera">
                            <i class="fas fa-play"></i>Bật Camera
                        </button>
                        <button class="btn btn-success btn-sm" id="captureImage">
                            <i class="fas fa-camera"></i>Chụp Hình
                        </button>
                        <button class="btn btn-warning btn-sm" id="openGate">
                            <i class="fas fa-door-open"></i>Mở Cổng
                        </button>
                        <button class="btn btn-danger btn-sm" id="closeGate">
                            <i class="fas fa-door-closed"></i>Đóng Cổng
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vehicle Info & Charts Section -->
        <div class="col-12 col-xl-4">
            <!-- Thông tin xe -->
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-1"></i>Thông tin xe</h6>
                </div>
                <div class="card-body">
                    <div class="border rounded p-3">
                        <h6 class="fw-bold mb-3">Xe đang xử lý:</h6>
                        <div class="mb-2">
                            <small class="text-muted">Trạng thái:</small>
                            <span class="badge bg-secondary ms-2" id="vehicle-status">Chờ xe</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Biển số:</small>
                            <span class="ms-2" id="plate-number">--</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Chủ xe:</small>
                            <span class="ms-2" id="owner-name">--</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Thời gian:</small>
                            <span class="ms-2" id="timestamp">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Traffic Chart -->
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-chart-line me-1"></i>Lưu lượng xe (24h qua)</h6>
                </div>
                <div class="card-body p-2">
                    <div class="chart-container">
                        <canvas id="trafficChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Alerts -->
            <div class="card">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-bell me-1"></i>Cảnh báo
                    </h6>
                    {% if long_term_vehicles or unregistered_vehicles %}
                    <span class="badge bg-danger">{{ long_term_vehicles.count|add:unregistered_vehicles.count }}</span>
                    {% endif %}
                </div>
                <div class="card-body p-2">
                    {% if long_term_vehicles %}
                    <div class="alert alert-warning py-2 mb-2">
                        <h6 class="mb-2"><i class="fas fa-clock me-1"></i>Xe gửi quá 24 giờ</h6>
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Biển số</th>
                                        <th>Thời gian vào</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for history in long_term_vehicles %}
                                    <tr>
                                        <td><span class="badge bg-warning text-dark">{{ history.plate_number }}</span></td>
                                        <td>{{ history.time_in|date:"d/m/Y H:i" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    {% if unregistered_vehicles %}
                    <div class="alert alert-danger py-2 mb-0">
                        <h6 class="mb-2"><i class="fas fa-exclamation-circle me-1"></i>Xe chưa đăng ký</h6>
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Biển số</th>
                                        <th>Thời gian vào</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for history in unregistered_vehicles %}
                                    <tr>
                                        <td><span class="badge bg-danger text-white">{{ history.plate_number }}</span></td>
                                        <td>{{ history.time_in|date:"d/m/Y H:i" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    {% if not long_term_vehicles and not unregistered_vehicles %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <p class="mb-0">Không có cảnh báo</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
    // Traffic Chart
    const trafficData = JSON.parse('{{ hourly_traffic|safe }}');
    const ctx = document.getElementById('trafficChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: trafficData.map(data => `${data.hour}:00`),
            datasets: [{
                label: 'Số lượt xe',
                data: trafficData.map(data => data.count),
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // Khởi tạo kết nối Socket.IO
    const socket = io('http://127.0.0.1:5000');

    // Lắng nghe sự kiện vehicle_info từ server
    socket.on('vehicle_info', (data) => {
        updateVehicleInfo(data);
        
        // Cập nhật dashboard nếu có thay đổi số lượng xe
        if (data.type === 'entrance') {
            // Xe vào bãi - tăng số xe đang đỗ, giảm chỗ trống
            updateDashboardStats(1);
        } else if (data.type === 'exit') {
            // Xe ra khỏi bãi - giảm số xe đang đỗ, tăng chỗ trống
            updateDashboardStats(-1);
        }
    });

    // Hàm cập nhật thông tin xe
    function updateVehicleInfo(data) {
        // Cập nhật trạng thái
        const statusBadge = document.getElementById('vehicle-status');
        statusBadge.textContent = data.status;
        statusBadge.className = 'badge ms-2 ' + 
            (data.is_registered ? 'bg-success' : 'bg-warning');

        // Cập nhật biển số
        document.getElementById('plate-number').textContent = data.license_plate;

        // Cập nhật chủ xe
        document.getElementById('owner-name').textContent = 
            data.is_registered ? data.vehicle_owner : 'Chưa đăng ký';

        // Cập nhật thời gian
        document.getElementById('timestamp').textContent = data.entry_time;

        // Hiệu ứng highlight khi có thông tin mới
        const infoContainer = document.querySelector('.border.rounded.p-3');
        infoContainer.style.transition = 'background-color 0.3s ease';
        infoContainer.style.backgroundColor = '#fff3cd';
        setTimeout(() => {
            infoContainer.style.backgroundColor = '';
        }, 1000);

        // Chơi âm thanh thông báo
        playNotificationSound();
    }

    // Hàm cập nhật số liệu thống kê trên dashboard
    function updateDashboardStats(change) {
        // Cập nhật số xe đang đỗ
        const parkedElement = document.querySelector('.card.bg-primary .mb-0');
        let parkedCount = parseInt(parkedElement.textContent);
        parkedCount += change;
        parkedElement.textContent = parkedCount;
        
        // Cập nhật số chỗ trống
        const availableElement = document.querySelector('.card.bg-success .mb-0');
        let availableCount = parseInt(availableElement.textContent);
        availableCount -= change;
        availableElement.textContent = availableCount;
        
        // Tính và cập nhật tỷ lệ lấp đầy
        const totalSpaces = parkedCount + availableCount;
        const occupancyRate = (parkedCount / totalSpaces * 100).toFixed(1);
        const occupancyElement = document.querySelector('.card.bg-info .mb-0');
        occupancyElement.textContent = occupancyRate + '%';
        
        // Highlight card với hiệu ứng
        highlightCard(change > 0 ? '.card.bg-primary' : '.card.bg-success');
    }
    
    // Hàm tạo hiệu ứng highlight cho card khi có thay đổi
    function highlightCard(selector) {
        const card = document.querySelector(selector);
        card.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';
        card.style.transform = 'translateY(-5px)';
        card.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
        
        setTimeout(() => {
            card.style.transform = '';
            card.style.boxShadow = '';
        }, 1000);
    }

    // Hàm phát âm thanh thông báo
    function playNotificationSound() {
        const audio = new Audio('/sta tic/notification.mp3');
        audio.volume = 0.5;
        audio.play().catch(error => {
            console.log('Error playing notification sound:', error);
        });
    }

    // Xử lý sự kiện kết nối/ngắt kết nối
    socket.on('connect', () => {
        console.log('Connected to server');
        const vehicleStatus = document.getElementById('vehicle-status');
        vehicleStatus.textContent = 'Đã kết nối - Chờ xe';
        vehicleStatus.className = 'badge bg-success ms-2';
    });

    socket.on('disconnect', () => {
        console.log('Disconnected from server');
        const vehicleStatus = document.getElementById('vehicle-status');
        vehicleStatus.textContent = 'Mất kết nối';
        vehicleStatus.className = 'badge bg-danger ms-2';
    });

    // Camera and Gate Control
    document.getElementById('startCamera').addEventListener('click', function() {
        // Logic for starting camera
    });

    document.getElementById('captureImage').addEventListener('click', function() {
        // Logic for capturing image
    });

    document.getElementById('openGate').addEventListener('click', function() {
        // Logic for opening gate
    });

    document.getElementById('closeGate').addEventListener('click', function() {
        // Logic for closing gate
    });
</script>
{% endblock %}